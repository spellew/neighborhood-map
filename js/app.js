"use strict";var loadScriptAsync=function(e){var o=document.createElement("script");o.async=!1,o.onload=e.onLoad,o.onerror=e.onError,o.src=e.src,document.head.appendChild(o)},handleLeafletLoad=function(){loadScriptAsync({src:"js/lib/leaflet.smoothmarkerbouncing.js",onLoad:handleBouncingLoad,onError:handleBouncingError});var e=L.map("map",{zoom:13,center:[0,0],keyboard:!1});L.tileLayer("https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}",{attribution:'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',maxZoom:18,id:"mapbox.streets",accessToken:"pk.eyJ1Ijoic3BlbGxldyIsImEiOiJjamNqdW5iazgzazI0MndudGh6NjVqM2xrIn0.VML7TdhGwdJlFXauBgwheQ"}).addTo(e),window.map=e},handleLeafletError=function(){alert("There was an error loading in the map, please try again later.")},handleBouncingLoad=function(){requestNearbyLocations()},handleBouncingError=function(){alert("There was a problem animating the markers bouncing. They'll still be displayed, just static."),requestNearbyLocations()},requestNearbyLocations=function(){"geolocation"in navigator?navigator.geolocation.getCurrentPosition(function(e){var o=new Headers,a={latitude:e.coords.latitude,longitude:e.coords.longitude};o.append("Authorization","Bearer jUL5Qrgqy7eslfY1y5PvSVgs_RKYZgLLsib9NIJEFUC5JEfjrzBBoN56g_ZBVb-R_NFJC_qtY-jchsSKYBnc0cIOOqxMJtWo4brlDaUCcmklzzC2vyLDob_ZlIP7WnYx");var n="https://cryptic-headland-94862.herokuapp.com/https://api.yelp.com/v3/businesses/search?"+Object.keys(a).map(function(e){return e+"="+a[e]}).join("&");fetch(n,{headers:o}).then(function(e){if(!e.ok)throw Error(e.statusText);return e.json()}).then(function(e){displayLocations(e.businesses)}).catch(function(e){console.log("Error: ",e),alert("There was an error getting places near you. Displaying fallback..."),displayLocations(fallbackLocations,!0)})}):(alert("It seems like your browser is missing the Geolocation API. Displaying fallback..."),displayLocations(fallbackLocations,!0))},displayLocations=function(e,o){ko.applyBindings(new function(){var t=this,n=window.map,r=L.featureGroup();t.filter=ko.observable(""),t.locations=ko.observableArray(e),t.filteredLocations=ko.observableArray(t.locations()),t.isDrawerOpen=ko.observable(!0),t.toggleDrawer=function(){t.isDrawerOpen(!t.isDrawerOpen()),n.invalidateSize()},t.redrawMarkers=function(){r.clearLayers(),t.filteredLocations().forEach(function(e){var o=L.marker([e.coordinates.latitude,e.coordinates.longitude]).setBouncingOptions({exclusive:!0}).addTo(n),a="<figcaption>"+e.name+" ["+e.price+"]</figcaption>";e.marker=o,e.focused=!1,o.bindPopup(L.popup({closeOnClick:!1,closeOnEscapeKey:!1}).setContent(e.image_url?'<figure>\n          <img class="photo-popup" src="'+e.image_url+'" alt="'+e.name+'" />\n          '+a+"\n        </figure>":a)),o.on("mouseover",function(){t.handleMarkerMouseOver(e)}),o.on("mouseout",function(){t.handleMarkerMouseOut(e)}),o.on("click",function(){t.handleMarkerClick(e)}),r.addLayer(o)}),r.getLayers().length&&n.fitBounds(r.getBounds(),{padding:[50,50]})},t.handleMarkerMouseOver=function(e){e.marker.bounce()},t.handleMarkerMouseOut=function(e){e.focused||e.marker.stopBouncing()},t.handleMarkerClick=function(e){var o=e.name;t.filter(o),t.filterLocations(null,null,o),e.marker.openPopup(),Array.from(document.getElementsByClassName("leaflet-popup-close-button")).forEach(function(e){e.addEventListener("click",t.resetFilter)}),e.focused=!0,e.marker.bounce(),window.scrollTo(0,0)},t.filterLocations=function(e,o,a){var n=(o?o.target.value:a).toLowerCase(),r=t.locations().filter(function(e){return e.name.toLowerCase().includes(n)});t.filteredLocations(r),t.redrawMarkers()},t.resetFilter=function(){t.filter(""),t.filteredLocations(t.locations()),t.redrawMarkers()},r.addTo(n),t.redrawMarkers()})};