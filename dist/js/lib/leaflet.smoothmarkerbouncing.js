"use strict";!function(x){var t=/([\w-]+): ([^;]+);/g,T={transform:"transform",WebkitTransform:"-webkit-transform",OTransform:"-o-transform",MozTransform:"-moz-transform",msTransform:"-ms-transform"}[x.DomUtil.TRANSFORM],a={};function i(n){for(var o={},i=t.exec(n);i;)o[i[1]]=i[2],i=t.exec(n);return o}function e(n){var o,i="";for(o in n)i+=o+": "+n[o]+"; ";return i}function u(n,o,i,t){for(var e,s=Math.round(n+Math.cos(i)*(2*t)),r=Math.round(o+Math.sin(i)*(2*t)),c=Math.abs(s-n),u=n<s?1:-1,a=Math.abs(r-o),h=o<r?1:-1,g=(a<c?c:-a)/2,M=[],l=0;M.push([n,o]),++l!==t;)-c<(e=g)&&(g-=a,n+=u),e<a&&(g+=c,o+=h);return M}function o(n,o,i,t){for(var e=[],s=t+1;s--;)e[s]=" matrix3d(1,0,0,0,0,"+(i-s)/i+",0,0,0,0,1,0,"+n+","+(o+s)+",0,1) ";return e}function n(n,o){var i,t=o+n,e=[];if(a[t])return a[t];for(i=1;i<=n;)e.push(i++);for(i=n;i--;)e.push(i);return a[t]=e}function s(n,o,i){var t,e,s=i+n+"_"+o,r=[],c=[],u=0;if(a[s])return a[s];for(r[n]=o,r[0]=0,e=n;--e;)r[e]=Math.round(o/(n-e));for(e=n;e--;)r.push(r[e]);for(e=0,t=r.length;e<t;e++)u+=r[e],c.push(u);return a[s]=c}x.Marker._bouncingMarkers=[],x.Marker.setBouncingOptions=function(n){x.extend(x.Marker.prototype._bouncingOptions,n)},x.Marker.getBouncingMarkers=function(){return x.Marker._bouncingMarkers},x.Marker.stopAllBouncingMarkers=function(){for(var n;n=x.Marker._bouncingMarkers.shift();)n._bouncingMotion.isBouncing=!1},x.Marker._addBouncingMarker=function(n,o){o||n._bouncingOptions.exclusive?x.Marker.stopAllBouncingMarkers():x.Marker._stopEclusiveMarkerBouncing(),x.Marker._bouncingMarkers.push(n)},x.Marker._removeBouncingMarker=function(n){var o=x.Marker._bouncingMarkers.length;if(o)for(;o--;)if(x.Marker._bouncingMarkers[o]==n){x.Marker._bouncingMarkers.splice(o,1);break}},x.Marker._stopEclusiveMarkerBouncing=function(){var n=x.Marker._bouncingMarkers.length;if(n)for(;n--;)x.Marker._bouncingMarkers[n]._bouncingOptions.exclusive&&(x.Marker._bouncingMarkers[n]._bouncingMotion.isBouncing=!1,x.Marker._bouncingMarkers.splice(n,1))},x.Marker.include({_bouncingOptions:{bounceHeight:15,contractHeight:12,bounceSpeed:52,contractSpeed:52,shadowAngle:-Math.PI/4,elastic:!0,exclusive:!1},setBouncingOptions:function(n){return this.hasOwnProperty("_bouncingOptions")||(this._bouncingOptions=x.extend({},x.Marker.prototype._bouncingOptions)),x.extend(this._bouncingOptions,n),this._calculateTimeline(),this._calculateTransforms(),this},isBouncing:function(){return this._bouncingMotion.isBouncing},bounce:function(){var o=this,i=this._icon,t=this._shadow,n=o._bouncingOptions,e=o._bouncingMotion,s=(n.bounceHeight,n.contractHeight,n.bounceSpeed),r=(n.contractSpeed,n.shadowAngle),c=n.elastic,u=n.exclusive,a=e.moveSteps,h=e.moveDelays,g=e.resizeSteps,M=e.resizeDelays,l=a.length,b=g.length,_=e.baseIconCssText,p=e.baseShadowCssText,f=x.Browser.any3d,d=null;if(!e.bouncingAnimationPlaying)return 1==arguments.length&&(d=arguments[0]),x.Marker._addBouncingMarker(o,u),e.isBouncing=!0,e.bouncingAnimationPlaying=!0,v(),o;function k(n){i.style.cssText=_+"z-index: "+o._zIndex+";"+T+": "+e.iconMoveTransforms[n],t&&(t.style.cssText=p+T+": "+e.shadowMoveTransforms[n])}function y(n){i.style.cssText=_+"z-index: "+o._zIndex+";",i.style.left=e.iconMovePoints[n][0]+"px",i.style.top=e.iconMovePoints[n][1]+"px",t&&(t.style.cssText=p,t.style.left=e.shadowMovePoints[n][0]+"px",t.style.top=e.shadowMovePoints[n][1]+"px")}function m(n){i.style.cssText=_+"z-index: "+o._zIndex+";"+T+": "+e.iconResizeTransforms[n],t&&null!=r&&(t.style.cssText=p+T+": "+e.shadowResizeTransforms[n])}function v(){null!==d&&(--d||(e.isBouncing=!1,e.bouncingAnimationPlaying=!1));var n=l;if(f)for(;n--;)setTimeout(k,h[n],a[n]);else for(;n--;)setTimeout(y,h[n],a[n]);setTimeout(function(){c&&f?function(){var n=b;setTimeout(function(){e.isBouncing||(e.bouncingAnimationPlaying=!1)},M[n]);for(;n--;)setTimeout(m,M[n],g[n]);setTimeout(function(){e.isBouncing&&v()},M[b-1])}():e.isBouncing?setTimeout(v,s):e.bouncingAnimationPlaying=!1},h[l-1])}e.isBouncing=!0},stopBouncing:function(){return this._bouncingMotion.isBouncing=!1,x.Marker._removeBouncingMarker(this),this},toggleBouncing:function(){return this._bouncingMotion.isBouncing?this.stopBouncing():this.bounce(),this},_calculateTimeline:function(){this._bouncingMotion.moveSteps=n(this._bouncingOptions.bounceHeight,"moveSteps_"),this._bouncingMotion.moveDelays=s(this._bouncingOptions.bounceHeight,this._bouncingOptions.bounceSpeed,"moveDelays_"),this._bouncingOptions.elastic&&(this._bouncingMotion.resizeSteps=n(this._bouncingOptions.contractHeight,"resizeSteps_"),this._bouncingMotion.resizeDelays=s(this._bouncingOptions.contractHeight,this._bouncingOptions.contractSpeed,"resizeDelays_"))},_calculateTransforms:function(){if(x.Browser.any3d){if(this.options.icon.options.iconSize)var n=this.options.icon.options.iconSize[1];else n=this._iconObj.options.iconSize[1];this._bouncingMotion.iconMoveTransforms=function(n,o,i){for(var t=[],e=i+1;e--;)t[e]=" matrix3d(1,0,0,0,0,1,0,0,0,0,1,0,"+n+","+(o-e)+",0,1) ";return t}(this._bouncingMotion.x,this._bouncingMotion.y,this._bouncingOptions.bounceHeight),this._bouncingMotion.iconResizeTransforms=o(this._bouncingMotion.x,this._bouncingMotion.y,n,this._bouncingOptions.contractHeight),this._shadow&&(this._bouncingMotion.shadowMoveTransforms=function(n,o,i,t){var e=[],s=i+1;if(null!=t)var r=u(n,o,t,i+1);else{r=[];for(var c=0;c<=i;c++)r[c]=[n,o]}for(;s--;)e[s]=" matrix3d(1,0,0,0,0,1,0,0,0,0,1,0,"+r[s][0]+","+r[s][1]+",0,1) ";return e}(this._bouncingMotion.x,this._bouncingMotion.y,this._bouncingOptions.bounceHeight,this._bouncingOptions.shadowAngle),this._bouncingMotion.shadowResizeTransforms=o(this._bouncingMotion.x,this._bouncingMotion.y,this.options.icon.options.shadowSize[1],this._bouncingOptions.contractHeight))}else this._bouncingMotion.iconMovePoints=function(n,o,i){for(var t=[],e=i+1;e--;)t[e]=[n,o-e];return t}(this._bouncingMotion.x,this._bouncingMotion.y,this._bouncingOptions.bounceHeight),this._bouncingMotion.shadowMovePoints=function(n,o,i,t){if(null!=t)return u(n,o,t,i+1);for(var e=[],s=0;s<=i;s++)e[s]=[n,o];return e}(this._bouncingMotion.x,this._bouncingMotion.y,this._bouncingOptions.bounceHeight,this._bouncingOptions.shadowAngle)}}),x.Marker.addInitHook(function(){this._bouncingMotion={isBouncing:!1,bouncingAnimationPlaying:!1},this._calculateTimeline()});var r=x.Marker.prototype._setPos,c=x.Marker.prototype.onAdd,h=x.Marker.prototype.setIcon,g=x.Marker.prototype._on;x.Marker.prototype._setPos=function(n){r.call(this,n),this._bouncingMotion.x=n.x,this._bouncingMotion.y=n.y,this._calculateTransforms()},x.Marker.prototype.onAdd=function(n){c.call(this,n);var o=i(this._icon.style.cssText);delete o[T],delete o["z-index"],o.opacity=this.options.opacityWhenUnclustered||this.options.opacity||1,this._bouncingMotion.baseIconCssText=e(o),this._shadow&&(delete(o=i(this._shadow.style.cssText))[T],delete o.opacity,this._bouncingMotion.baseShadowCssText=e(o)),this._bouncingMotion.bouncingAnimationPlaying=!1,this._bouncingMotion.isBouncing&&this.bounce()},x.Marker.prototype.setIcon=function(n){h.call(this,n);var o=i(this._icon.style.cssText);delete o[T],delete o["z-index"],o.opacity=this.options.opacityWhenUnclustered||this.options.opacity||1,this._bouncingMotion.baseIconCssText=e(o),this._shadow&&(delete(o=i(this._shadow.style.cssText))[T],delete o.opacity,this._bouncingMotion.baseShadowCssText=e(o))},x.Marker.prototype._on=function(o,i,n){g.call(this,o,function(n){"click"===o&&document.activeElement.blur(),i.call(this,n)},n)}}(L);